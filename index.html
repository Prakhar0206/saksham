<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Canvas Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0a0e1a;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            user-select: none;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        #viewport {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: grab;
            touch-action: none;
        }

        #viewport.panning { cursor: grabbing; }

        #canvas {
            position: absolute;
            left: 0;
            top: 0;
            transform-origin: 0 0;
            will-change: transform;
        }

        .grid-bg {
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: -1;
        }

        .note {
            position: absolute;
            width: 320px;
            background: linear-gradient(145deg, #1a1f2e 0%, #151923 100%);
            border-radius: 12px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            transition: box-shadow 0.15s ease, border-color 0.15s ease;
            will-change: transform;
            contain: layout style paint;
        }

        .note.selected {
            border-color: #3b82f6;
            box-shadow: 
                0 0 0 3px rgba(59, 130, 246, 0.2),
                0 10px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .note.dragging {
            cursor: grabbing;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .note:hover {
            box-shadow: 
                0 15px 50px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.08);
        }

        .note-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: rgba(20, 25, 35, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 10px 10px 0 0;
            cursor: move;
            min-height: 48px;
            gap: 10px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            flex: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .drag-icon {
            width: 20px;
            height: 20px;
            display: grid;
            grid-template: repeat(3, 1fr) / repeat(2, 1fr);
            gap: 2px;
            opacity: 0.3;
            flex-shrink: 0;
        }

        .drag-icon span {
            width: 3px;
            height: 3px;
            background: #94a3b8;
            border-radius: 50%;
        }

        .note-meta {
            color: #64748b;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-content {
            background: transparent;
            border: none;
            color: #e2e8f0;
            padding: 16px;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            width: 100%;
            min-height: 120px;
            max-height: 600px;
            overflow-y: auto;
            user-select: text;
            font-family: inherit;
        }

        .note-content::placeholder {
            color: #475569;
        }

        .note-content::-webkit-scrollbar { width: 6px; }
        .note-content::-webkit-scrollbar-track { background: transparent; }
        .note-content::-webkit-scrollbar-thumb { 
            background: rgba(148, 163, 184, 0.2); 
            border-radius: 3px; 
        }
        .note-content::-webkit-scrollbar-thumb:hover { 
            background: rgba(148, 163, 184, 0.3); 
        }

        .btn {
            background: rgba(51, 65, 85, 0.6);
            border: none;
            color: #cbd5e1;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            font-size: 16px;
        }

        .btn:hover {
            background: rgba(71, 85, 105, 0.8);
            color: #e2e8f0;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .color-picker {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 6px;
        }

        .color-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
            position: relative;
        }

        .color-dot:hover {
            transform: scale(1.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .color-dot.active {
            border-color: rgba(255, 255, 255, 0.6);
        }

        .color-dot.active::after {
            content: '‚úì';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .resize-handle {
            position: absolute;
            right: 0;
            bottom: 0;
            width: 30px;
            height: 30px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 12px;
            height: 12px;
            border-right: 2px solid #64748b;
            border-bottom: 2px solid #64748b;
        }

        .note:hover .resize-handle { opacity: 0.5; }
        .resize-handle:hover { opacity: 1 !important; }

        #toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 25, 35, 0.95);
            backdrop-filter: blur(20px);
            padding: 10px 16px;
            border-radius: 14px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            z-index: 2000;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .tool-btn {
            background: rgba(51, 65, 85, 0.6);
            border: none;
            color: #cbd5e1;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            font-family: inherit;
        }

        .tool-btn:hover {
            background: rgba(71, 85, 105, 0.8);
            transform: translateY(-1px);
        }

        .tool-btn:active {
            transform: translateY(0);
        }

        .tool-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .tool-btn.primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        .tool-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .tool-btn:disabled:hover {
            transform: none;
        }

        .divider {
            width: 1px;
            height: 24px;
            background: rgba(148, 163, 184, 0.2);
        }

        .counter {
            color: #64748b;
            font-size: 13px;
            padding: 0 6px;
        }

        .save-status {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #64748b;
            font-size: 12px;
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
        }

        .save-status.saving { color: #fbbf24; }
        .save-status.saved { color: #4ade80; }

        .zoom-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 2000;
        }

        .zoom-btn {
            width: 42px;
            height: 42px;
            background: rgba(20, 25, 35, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #cbd5e1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.15s ease;
            font-family: inherit;
        }

        .zoom-btn:hover {
            background: rgba(51, 65, 85, 0.95);
            border-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .zoom-display {
            text-align: center;
            color: #64748b;
            font-size: 11px;
            font-weight: 600;
            padding: 4px;
        }

        #search-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 25, 35, 0.95);
            backdrop-filter: blur(20px);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            z-index: 2100;
            min-width: 400px;
            max-width: 90vw;
            display: none;
        }

        #search-bar.active { display: block; }

        #search-input {
            width: 100%;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 12px 14px;
            color: #e2e8f0;
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }

        #search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .search-results {
            margin-top: 8px;
            max-height: 320px;
            overflow-y: auto;
        }

        .search-item {
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #cbd5e1;
            font-size: 13px;
        }

        .search-item:hover {
            background: rgba(51, 65, 85, 0.7);
            transform: translateX(4px);
        }

        .search-item mark {
            background: #fbbf24;
            color: #0f172a;
            padding: 2px 4px;
            border-radius: 3px;
        }

        #help-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #help-modal.active { display: flex; }

        .help-content {
            background: rgba(20, 25, 35, 0.98);
            backdrop-filter: blur(20px);
            padding: 32px 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .help-title {
            font-size: 24px;
            font-weight: 700;
            color: #e2e8f0;
            margin-bottom: 24px;
            text-align: center;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #64748b;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .shortcut-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px;
            color: #cbd5e1;
            font-size: 13px;
        }

        .shortcut-key {
            background: rgba(51, 65, 85, 0.6);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }

        .shortcut-desc {
            padding: 6px 0;
            color: #94a3b8;
        }

        .close-modal {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(51, 65, 85, 0.6);
            border: none;
            color: #94a3b8;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.15s;
        }

        .close-modal:hover {
            background: rgba(71, 85, 105, 0.8);
            color: #e2e8f0;
        }

        .selection-rect {
            position: absolute;
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            z-index: 999;
        }

        @media (max-width: 768px) {
            #toolbar {
                bottom: 10px;
                padding: 8px 12px;
                gap: 8px;
            }
            
            .tool-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .counter, .save-status { display: none; }
            
            #search-bar {
                min-width: calc(100vw - 40px);
            }

            .zoom-panel {
                top: auto;
                bottom: 80px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>
    
    <div id="viewport">
        <div id="canvas"></div>
    </div>

    <div id="toolbar">
        <button class="tool-btn primary" id="new-note" title="Ctrl+N">+ New</button>
        <span class="counter" id="note-count">0 notes</span>
        <div class="save-status saved" id="save-status">
            <span id="save-icon">‚úì</span>
            <span id="save-text">Saved</span>
        </div>
        <div class="divider"></div>
        <button class="tool-btn" id="search-btn" title="Ctrl+F">üîç</button>
        <button class="tool-btn" id="undo-btn" title="Ctrl+Z" disabled>‚Ü∂</button>
        <button class="tool-btn" id="redo-btn" title="Ctrl+Y" disabled>‚Ü∑</button>
        <button class="tool-btn" id="help-btn" title="?">?</button>
    </div>

    <div class="zoom-panel">
        <button class="zoom-btn" id="zoom-in" title="Ctrl + =">+</button>
        <div class="zoom-display" id="zoom-display">100%</div>
        <button class="zoom-btn" id="zoom-out" title="Ctrl + -">‚àí</button>
        <button class="zoom-btn" id="zoom-reset" title="Ctrl + 0">‚äô</button>
    </div>

    <div id="search-bar">
        <input type="text" id="search-input" placeholder="Search notes... (Press Esc to close)">
        <div class="search-results" id="search-results"></div>
    </div>

    <div id="help-modal">
        <div class="help-content">
            <button class="close-modal" id="close-help">√ó</button>
            <div class="help-title">‚å®Ô∏è Keyboard Shortcuts</div>
            
            <div class="help-section">
                <h3>Note Actions</h3>
                <div class="shortcut-grid">
                    <span class="shortcut-key">Ctrl+N</span>
                    <span class="shortcut-desc">Create new note</span>
                    <span class="shortcut-key">Ctrl+D</span>
                    <span class="shortcut-desc">Duplicate selected</span>
                    <span class="shortcut-key">Delete</span>
                    <span class="shortcut-desc">Delete selected</span>
                    <span class="shortcut-key">Esc</span>
                    <span class="shortcut-desc">Deselect all</span>
                </div>
            </div>

            <div class="help-section">
                <h3>History</h3>
                <div class="shortcut-grid">
                    <span class="shortcut-key">Ctrl+Z</span>
                    <span class="shortcut-desc">Undo last action</span>
                    <span class="shortcut-key">Ctrl+Y</span>
                    <span class="shortcut-desc">Redo action</span>
                </div>
            </div>

            <div class="help-section">
                <h3>View Controls</h3>
                <div class="shortcut-grid">
                    <span class="shortcut-key">Ctrl+F</span>
                    <span class="shortcut-desc">Search notes</span>
                    <span class="shortcut-key">Ctrl + =</span>
                    <span class="shortcut-desc">Zoom in</span>
                    <span class="shortcut-key">Ctrl + -</span>
                    <span class="shortcut-desc">Zoom out</span>
                    <span class="shortcut-key">Ctrl+0</span>
                    <span class="shortcut-desc">Reset zoom</span>
                </div>
            </div>

            <div class="help-section">
                <h3>Tips & Tricks</h3>
                <div class="shortcut-grid">
                    <span class="shortcut-key">Double-click</span>
                    <span class="shortcut-desc">Create note at position</span>
                    <span class="shortcut-key">Shift+Click</span>
                    <span class="shortcut-desc">Multi-select notes</span>
                    <span class="shortcut-key">Drag canvas</span>
                    <span class="shortcut-desc">Pan around workspace</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        const state = {
            notes: new Map(),
            selected: new Set(),
            zoom: 1,
            panX: 0,
            panY: 0,
            history: [],
            historyIndex: -1,
            maxHistory: 50,
            dragging: null,
            resizing: null,
            panning: null,
            selecting: null
        };

        const colors = {
            slate: { bg: 'linear-gradient(145deg, #1a1f2e 0%, #151923 100%)', dot: '#475569' },
            blue: { bg: 'linear-gradient(145deg, #1e3a8a 0%, #1e40af 100%)', dot: '#3b82f6' },
            emerald: { bg: 'linear-gradient(145deg, #065f46 0%, #047857 100%)', dot: '#10b981' },
            violet: { bg: 'linear-gradient(145deg, #5b21b6 0%, #6d28d9 100%)', dot: '#8b5cf6' },
            rose: { bg: 'linear-gradient(145deg, #be123c 0%, #e11d48 100%)', dot: '#f43f5e' },
            amber: { bg: 'linear-gradient(145deg, #d97706 0%, #f59e0b 100%)', dot: '#fbbf24' }
        };

        // ========== ELEMENTS ==========
        const el = {
            viewport: document.getElementById('viewport'),
            canvas: document.getElementById('canvas'),
            newNote: document.getElementById('new-note'),
            searchBtn: document.getElementById('search-btn'),
            searchBar: document.getElementById('search-bar'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            undoBtn: document.getElementById('undo-btn'),
            redoBtn: document.getElementById('redo-btn'),
            helpBtn: document.getElementById('help-btn'),
            helpModal: document.getElementById('help-modal'),
            closeHelp: document.getElementById('close-help'),
            noteCount: document.getElementById('note-count'),
            saveStatus: document.getElementById('save-status'),
            saveIcon: document.getElementById('save-icon'),
            saveText: document.getElementById('save-text'),
            zoomIn: document.getElementById('zoom-in'),
            zoomOut: document.getElementById('zoom-out'),
            zoomReset: document.getElementById('zoom-reset'),
            zoomDisplay: document.getElementById('zoom-display')
        };

        // ========== UTILITIES ==========
        function uid() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function debounce(fn, ms) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), ms);
            };
        }

        function clamp(val, min, max) {
            return Math.min(Math.max(val, min), max);
        }

        // ========== SAVE/LOAD ==========
        function saveToStorage() {
            try {
                el.saveStatus.className = 'save-status saving';
                el.saveIcon.textContent = '‚ü≥';
                el.saveText.textContent = 'Saving...';

                const data = {
                    notes: Array.from(state.notes.values()),
                    canvas: { zoom: state.zoom, panX: state.panX, panY: state.panY },
                    version: 1
                };
                localStorage.setItem('canvasData', JSON.stringify(data));

                setTimeout(() => {
                    el.saveStatus.className = 'save-status saved';
                    el.saveIcon.textContent = '‚úì';
                    el.saveText.textContent = 'Saved';
                }, 300);
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        const debouncedSave = debounce(saveToStorage, 500);

        function loadFromStorage() {
            try {
                const data = JSON.parse(localStorage.getItem('canvasData'));
                if (!data) return false;

                data.notes.forEach(note => {
                    state.notes.set(note.id, note);
                    renderNote(note);
                });

                if (data.canvas) {
                    state.zoom = data.canvas.zoom || 1;
                    state.panX = data.canvas.panX || 0;
                    state.panY = data.canvas.panY || 0;
                    updateCanvas();
                }

                updateCount();
                return true;
            } catch (e) {
                console.error('Load failed:', e);
                return false;
            }
        }

        // ========== HISTORY ==========
        function addHistory(action) {
            state.history = state.history.slice(0, state.historyIndex + 1);
            state.history.push(action);
            
            if (state.history.length > state.maxHistory) {
                state.history.shift();
            } else {
                state.historyIndex++;
            }
            
            updateHistoryBtns();
        }

        function undo() {
            if (state.historyIndex < 0) return;
            
            const action = state.history[state.historyIndex];
            executeHistoryAction(action, true);
            
            state.historyIndex--;
            updateHistoryBtns();
            debouncedSave();
        }

        function redo() {
            if (state.historyIndex >= state.history.length - 1) return;
            
            state.historyIndex++;
            const action = state.history[state.historyIndex];
            executeHistoryAction(action, false);
            
            updateHistoryBtns();
            debouncedSave();
        }

        function executeHistoryAction(action, isUndo) {
            switch (action.type) {
                case 'create':
                    if (isUndo) deleteNote(action.id);
                    else createNoteFromData(action.data);
                    break;
                case 'delete':
                    if (isUndo) createNoteFromData(action.data);
                    else deleteNote(action.id);
                    break;
                case 'update':
                    updateNoteFromData(isUndo ? action.before : action.after);
                    break;
            }
        }

        function updateHistoryBtns() {
            el.undoBtn.disabled = state.historyIndex < 0;
            el.redoBtn.disabled = state.historyIndex >= state.history.length - 1;
        }

        // ========== NOTE MANAGEMENT ==========
        function createNote(x, y) {
            const note = {
                id: uid(),
                x: x,
                y: y,
                width: 320,
                content: '',
                color: 'slate',
                created: Date.now(),
                modified: Date.now()
            };

            state.notes.set(note.id, note);
            renderNote(note);
            updateCount();

            addHistory({ type: 'create', id: note.id, data: {...note} });
            debouncedSave();

            // Focus the textarea
            setTimeout(() => {
                const noteEl = document.querySelector(`[data-id="${note.id}"]`);
                if (noteEl) {
                    noteEl.querySelector('.note-content').focus();
                }
            }, 50);

            return note;
        }

        function createNoteFromData(data) {
            state.notes.set(data.id, data);
            renderNote(data);
            updateCount();
        }

        function deleteNote(id) {
            const noteEl = document.querySelector(`[data-id="${id}"]`);
            if (noteEl) noteEl.remove();
            
            state.notes.delete(id);
            state.selected.delete(id);
            updateCount();
        }

        function updateNoteContent(id, content) {
            const note = state.notes.get(id);
            if (!note) return;

            const before = {...note};
            note.content = content;
            note.modified = Date.now();

            addHistory({ type: 'update', id, before, after: {...note} });
            debouncedSave();
        }

        function updateNoteColor(id, color) {
            const note = state.notes.get(id);
            if (!note) return;

            const before = {...note};
            note.color = color;
            note.modified = Date.now();

            addHistory({ type: 'update', id, before, after: {...note} });
            debouncedSave();
        }

        function updateNoteFromData(data) {
            const note = state.notes.get(data.id);
            if (!note) return;

            Object.assign(note, data);
            
            const noteEl = document.querySelector(`[data-id="${data.id}"]`);
            if (noteEl) {
                noteEl.style.left = data.x + 'px';
                noteEl.style.top = data.y + 'px';
                noteEl.style.width = data.width + 'px';
                noteEl.style.background = colors[data.color].bg;
                noteEl.querySelector('.note-content').value = data.content;
            }
        }

        function duplicateSelected() {
            const selected = Array.from(state.selected);
            if (selected.length === 0) return;

            state.selected.clear();

            selected.forEach(id => {
                const note = state.notes.get(id);
                if (!note) return;

                const newNote = {
                    ...note,
                    id: uid(),
                    x: note.x + 30,
                    y: note.y + 30,
                    created: Date.now(),
                    modified: Date.now()
                };

                state.notes.set(newNote.id, newNote);
                renderNote(newNote);
                state.selected.add(newNote.id);

                addHistory({ type: 'create', id: newNote.id, data: {...newNote} });
            });

            updateCount();
            updateSelection();
            debouncedSave();
        }

        function deleteSelected() {
            const selected = Array.from(state.selected);
            if (selected.length === 0) return;

            selected.forEach(id => {
                const note = state.notes.get(id);
                if (!note) return;

                deleteNote(id);
                addHistory({ type: 'delete', id, data: {...note} });
            });

            state.selected.clear();
            updateSelection();
            debouncedSave();
        }

        // ========== RENDERING ==========
        function renderNote(note) {
            const div = document.createElement('div');
            div.className = 'note';
            div.dataset.id = note.id;
            div.style.left = note.x + 'px';
            div.style.top = note.y + 'px';
            div.style.width = note.width + 'px';
            div.style.background = colors[note.color].bg;

            const colorDots = Object.keys(colors).map(key => 
                `<div class="color-dot ${key === note.color ? 'active' : ''}" 
                     style="background: ${colors[key].dot};" 
                     data-color="${key}"></div>`
            ).join('');

            div.innerHTML = `
                <div class="note-header">
                    <div class="header-left">
                        <div class="drag-icon">
                            ${Array(6).fill('<span></span>').join('')}
                        </div>
                        <div class="note-meta">${new Date(note.created).toLocaleDateString()}</div>
                    </div>
                    <div class="header-right">
                        <div class="color-picker">${colorDots}</div>
                        <button class="btn btn-delete">√ó</button>
                    </div>
                </div>
                <textarea class="note-content" placeholder="Type your note...">${note.content}</textarea>
                <div class="resize-handle"></div>
            `;

            el.canvas.appendChild(div);
            setupNoteEvents(div, note);
        }

        function setupNoteEvents(noteEl, note) {
            const header = noteEl.querySelector('.note-header');
            const textarea = noteEl.querySelector('.note-content');
            const deleteBtn = noteEl.querySelector('.btn-delete');
            const resizeHandle = noteEl.querySelector('.resize-handle');
            const colorDots = noteEl.querySelectorAll('.color-dot');

            // Select note
            noteEl.addEventListener('mousedown', (e) => {
                if (e.target.closest('.note-header') || 
                    e.target.closest('.btn') || 
                    e.target.closest('.color-dot') ||
                    e.target.closest('.resize-handle')) return;

                if (!e.shiftKey && !state.selected.has(note.id)) {
                    state.selected.clear();
                }
                state.selected.add(note.id);
                updateSelection();
            });

            // Drag
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.btn') || e.target.closest('.color-dot')) return;

                if (!state.selected.has(note.id)) {
                    state.selected.clear();
                    state.selected.add(note.id);
                    updateSelection();
                }

                const selected = Array.from(state.selected).map(id => ({
                    id,
                    note: state.notes.get(id),
                    el: document.querySelector(`[data-id="${id}"]`),
                    startX: state.notes.get(id).x,
                    startY: state.notes.get(id).y
                }));

                state.dragging = {
                    notes: selected,
                    startMouseX: e.clientX,
                    startMouseY: e.clientY
                };

                selected.forEach(item => item.el.classList.add('dragging'));
                e.preventDefault();
            });

            // Resize
            resizeHandle.addEventListener('mousedown', (e) => {
                state.resizing = {
                    id: note.id,
                    startWidth: note.width,
                    startX: e.clientX
                };
                e.preventDefault();
                e.stopPropagation();
            });

            // Content change
            let contentTimeout;
            textarea.addEventListener('input', (e) => {
                clearTimeout(contentTimeout);
                contentTimeout = setTimeout(() => {
                    updateNoteContent(note.id, e.target.value);
                }, 500);
            });

            // Delete
            deleteBtn.addEventListener('click', () => {
                const noteData = {...note};
                deleteNote(note.id);
                addHistory({ type: 'delete', id: note.id, data: noteData });
                debouncedSave();
            });

            // Color change
            colorDots.forEach(dot => {
                dot.addEventListener('click', (e) => {
                    const color = e.target.dataset.color;
                    noteEl.style.background = colors[color].bg;
                    updateNoteColor(note.id, color);
                    
                    colorDots.forEach(d => d.classList.remove('active'));
                    e.target.classList.add('active');
                });
            });
        }

        function updateSelection() {
            document.querySelectorAll('.note').forEach(el => {
                if (state.selected.has(el.dataset.id)) {
                    el.classList.add('selected');
                } else {
                    el.classList.remove('selected');
                }
            });
        }

        function updateCount() {
            const count = state.notes.size;
            el.noteCount.textContent = `${count} note${count !== 1 ? 's' : ''}`;
        }

        // ========== CANVAS TRANSFORM ==========
        function updateCanvas() {
            el.canvas.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
            el.zoomDisplay.textContent = Math.round(state.zoom * 100) + '%';
        }

        function setZoom(newZoom) {
            state.zoom = clamp(newZoom, 0.25, 3);
            updateCanvas();
            debouncedSave();
        }

        // ========== SEARCH ==========
        function performSearch() {
            const query = el.searchInput.value.toLowerCase().trim();
            el.searchResults.innerHTML = '';

            if (!query) return;

            const results = [];
            state.notes.forEach(note => {
                if (note.content.toLowerCase().includes(query)) {
                    results.push(note);
                }
            });

            if (results.length === 0) {
                el.searchResults.innerHTML = '<div class="search-item" style="opacity:0.5">No results found</div>';
                return;
            }

            results.forEach(note => {
                const div = document.createElement('div');
                div.className = 'search-item';
                
                const content = note.content.slice(0, 100);
                const regex = new RegExp(`(${query})`, 'gi');
                const highlighted = content.replace(regex, '<mark>$1</mark>');
                
                div.innerHTML = highlighted || '(Empty note)';
                div.addEventListener('click', () => {
                    // Pan to note
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    state.panX = centerX - (note.x * state.zoom) - (note.width * state.zoom / 2);
                    state.panY = centerY - (note.y * state.zoom) - 100;
                    updateCanvas();
                    
                    // Select note
                    state.selected.clear();
                    state.selected.add(note.id);
                    updateSelection();
                    
                    // Close search
                    el.searchBar.classList.remove('active');
                });
                
                el.searchResults.appendChild(div);
            });
        }

        const debouncedSearch = debounce(performSearch, 300);

        // ========== MOUSE EVENTS ==========
        let mouseMoveHandler = (e) => {
            if (state.dragging) {
                const dx = (e.clientX - state.dragging.startMouseX) / state.zoom;
                const dy = (e.clientY - state.dragging.startMouseY) / state.zoom;

                state.dragging.notes.forEach(item => {
                    item.note.x = item.startX + dx;
                    item.note.y = item.startY + dy;
                    item.el.style.left = item.note.x + 'px';
                    item.el.style.top = item.note.y + 'px';
                });
            } else if (state.resizing) {
                const dx = e.clientX - state.resizing.startX;
                const newWidth = clamp(state.resizing.startWidth + dx, 280, 600);
                
                const note = state.notes.get(state.resizing.id);
                const noteEl = document.querySelector(`[data-id="${state.resizing.id}"]`);
                
                if (note && noteEl) {
                    note.width = newWidth;
                    noteEl.style.width = newWidth + 'px';
                }
            } else if (state.panning) {
                const dx = e.clientX - state.panning.startX;
                const dy = e.clientY - state.panning.startY;
                state.panX = state.panning.startPanX + dx;
                state.panY = state.panning.startPanY + dy;
                updateCanvas();
            } else if (state.selecting) {
                const x1 = Math.min(state.selecting.startX, e.clientX);
                const y1 = Math.min(state.selecting.startY, e.clientY);
                const x2 = Math.max(state.selecting.startX, e.clientX);
                const y2 = Math.max(state.selecting.startY, e.clientY);

                state.selecting.rect.style.left = x1 + 'px';
                state.selecting.rect.style.top = y1 + 'px';
                state.selecting.rect.style.width = (x2 - x1) + 'px';
                state.selecting.rect.style.height = (y2 - y1) + 'px';

                // Update selection
                state.selected.clear();
                document.querySelectorAll('.note').forEach(noteEl => {
                    const rect = noteEl.getBoundingClientRect();
                    if (rect.right > x1 && rect.left < x2 && rect.bottom > y1 && rect.top < y2) {
                        state.selected.add(noteEl.dataset.id);
                    }
                });
                updateSelection();
            }
        };

        let mouseUpHandler = () => {
            if (state.dragging) {
                state.dragging.notes.forEach(item => {
                    item.el.classList.remove('dragging');
                });
                state.dragging = null;
                debouncedSave();
            }
            
            if (state.resizing) {
                state.resizing = null;
                debouncedSave();
            }
            
            if (state.panning) {
                state.panning = null;
                el.viewport.classList.remove('panning');
                debouncedSave();
            }

            if (state.selecting) {
                state.selecting.rect.remove();
                state.selecting = null;
            }
        };

        window.addEventListener('mousemove', mouseMoveHandler);
        window.addEventListener('mouseup', mouseUpHandler);

        // Canvas panning
        el.viewport.addEventListener('mousedown', (e) => {
            if (e.target.closest('.note') || e.target.closest('#toolbar') || 
                e.target.closest('.zoom-panel') || e.target.closest('#search-bar')) return;

            if (e.shiftKey) {
                // Multi-select with drag
                const rect = document.createElement('div');
                rect.className = 'selection-rect';
                rect.style.left = e.clientX + 'px';
                rect.style.top = e.clientY + 'px';
                document.body.appendChild(rect);

                state.selecting = {
                    startX: e.clientX,
                    startY: e.clientY,
                    rect: rect
                };
            } else {
                // Pan canvas
                state.panning = {
                    startX: e.clientX,
                    startY: e.clientY,
                    startPanX: state.panX,
                    startPanY: state.panY
                };
                el.viewport.classList.add('panning');
            }

            e.preventDefault();
        });

        // Double-click to create note
        el.viewport.addEventListener('dblclick', (e) => {
            if (e.target.closest('.note')) return;

            const x = (e.clientX - state.panX) / state.zoom;
            const y = (e.clientY - state.panY) / state.zoom;
            createNote(x, y);
        });

        // ========== KEYBOARD SHORTCUTS ==========
        window.addEventListener('keydown', (e) => {
            // Don't trigger if typing in textarea
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                if (e.key === 'Escape') {
                    e.target.blur();
                    if (e.target.id === 'search-input') {
                        el.searchBar.classList.remove('active');
                    }
                }
                return;
            }

            const ctrl = e.ctrlKey || e.metaKey;

            if (ctrl && e.key === 'n') {
                e.preventDefault();
                const x = (window.innerWidth / 2 - state.panX) / state.zoom;
                const y = (window.innerHeight / 2 - state.panY) / state.zoom;
                createNote(x, y);
            } else if (ctrl && e.key === 'd') {
                e.preventDefault();
                duplicateSelected();
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault();
                deleteSelected();
            } else if (e.key === 'Escape') {
                state.selected.clear();
                updateSelection();
                el.searchBar.classList.remove('active');
                el.helpModal.classList.remove('active');
            } else if (ctrl && e.key === 'z') {
                e.preventDefault();
                undo();
            } else if (ctrl && e.key === 'y') {
                e.preventDefault();
                redo();
            } else if (ctrl && e.key === 'f') {
                e.preventDefault();
                el.searchBar.classList.toggle('active');
                if (el.searchBar.classList.contains('active')) {
                    el.searchInput.focus();
                }
            } else if (ctrl && (e.key === '=' || e.key === '+')) {
                e.preventDefault();
                setZoom(state.zoom + 0.1);
            } else if (ctrl && (e.key === '-' || e.key === '_')) {
                e.preventDefault();
                setZoom(state.zoom - 0.1);
            } else if (ctrl && e.key === '0') {
                e.preventDefault();
                state.zoom = 1;
                updateCanvas();
            } else if (e.key === '?') {
                el.helpModal.classList.toggle('active');
            }
        });

        // ========== UI EVENTS ==========
        el.newNote.addEventListener('click', () => {
            const x = (window.innerWidth / 2 - state.panX) / state.zoom;
            const y = (window.innerHeight / 2 - state.panY) / state.zoom;
            createNote(x, y);
        });

        el.searchBtn.addEventListener('click', () => {
            el.searchBar.classList.toggle('active');
            if (el.searchBar.classList.contains('active')) {
                el.searchInput.focus();
            }
        });

        el.searchInput.addEventListener('input', debouncedSearch);

        el.undoBtn.addEventListener('click', undo);
        el.redoBtn.addEventListener('click', redo);

        el.helpBtn.addEventListener('click', () => {
            el.helpModal.classList.add('active');
        });

        el.closeHelp.addEventListener('click', () => {
            el.helpModal.classList.remove('active');
        });

        el.helpModal.addEventListener('click', (e) => {
            if (e.target === el.helpModal) {
                el.helpModal.classList.remove('active');
            }
        });

        el.zoomIn.addEventListener('click', () => setZoom(state.zoom + 0.1));
        el.zoomOut.addEventListener('click', () => setZoom(state.zoom - 0.1));
        el.zoomReset.addEventListener('click', () => {
            state.zoom = 1;
            updateCanvas();
        });

        // Wheel zoom
        el.viewport.addEventListener('wheel', (e) => {
            if (!e.ctrlKey) return;
            e.preventDefault();
            
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            setZoom(state.zoom + delta);
        }, { passive: false });

        // ========== INIT ==========
        window.addEventListener('load', () => {
            const loaded = loadFromStorage();
            
            if (!loaded) {
                // Center canvas
                state.panX = 0;
                state.panY = 0;
                updateCanvas();
                
                // Show welcome
                setTimeout(() => {
                    el.helpModal.classList.add('active');
                }, 500);
            } else {
                updateCanvas();
            }
        });

        // Auto-save on page unload
        window.addEventListener('beforeunload', () => {
            saveToStorage();
        });

        console.log('‚ú® Infinite Canvas Pro loaded');
    </script>
</body>
</html>
